<!DOCTYPE html>
<html lang="zh-Hant">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>LIFF Share Example</title>
	<!-- 載入資料（改為 Vercel /data/ 路徑） -->
	<script src="/data/common.js"></script>
	<script src="/data/data.js"></script>
	<link rel="stylesheet" type="text/css" href="/data/styles.css">
	<!-- flex2html -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PamornT/flex2html@main/css/flex2html.css" />
	<script src="https://cdn.jsdelivr.net/gh/PamornT/flex2html@main/js/flex2html.min.js"></script>
	<!-- liff -->
	<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
	<!-- 提示框 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.5/dist/sweetalert2.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.5/dist/sweetalert2.min.js"></script>
	<!-- dom-to-image -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
	<!-- fontawesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
	<script src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
	<!-- pickr 調色盤 -->
	<link rel="stylesheet" type="text/css"
		href="https://cdn.jsdelivr.net/npm/@simonwep/pickr@latest/dist/themes/nano.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr@latest/dist/pickr.min.js"></script>

</head>

<body>
	<div class="loader" id="loader">
		<div class="sk-chase">
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
		</div>
	</div>

	<div class="form-container">
		<h1>LIFF Card Share</h1>
		<div class="downloadFlex">
			<div style="width: 310px; height: auto; overflow: hidden;">
				<div class="chatbox">
					<div id="flex2html_main"></div>
				</div>
			</div>
		</div>
	</div>

	<script>
		function createFlex(data_card) {
			mainTitle_1 = data_card.mainTitle_1 || mainTitle_1;
			mainTitle_2 = data_card.mainTitle_2 || mainTitle_2;
			memberId = data_card.memberId || memberId;
			subTitle_2 = data_card.subTitle_2 || subTitle_2;
			textContent_1 = data_card.textContent_1 || textContent_1;
			textContent_1_url = data_card.textContent_1_url || textContent_1_url;
			textContent_2 = data_card.textContent_2 || textContent_2;
			textContent_2_url = data_card.textContent_2_url || textContent_2_url;
			displayName = data_card.displayName || displayName;
			textColor = data_card.textColor || textColor;

			// 取得 card_json[0] 作為 flexJsonStatic
			if (window.flexJsonStaticFromSheet) {
				flexJsonStatic = window.flexJsonStaticFromSheet;
			}
			console.log('[download_card] 欄位資料', {
				mainTitle_1, mainTitle_2, memberId, subTitle_2, textContent_1, textContent_1_url, textContent_2, textContent_2_url, displayName, textColor
			});
			flexJsonList = createFlexJsonList();
			console.log('[download_card] flexJsonList', flexJsonList);
			my_flexToHtml("flex2html_main", flexJsonList);
		}

		window.onload = function () {
			document.getElementById('loader').style.display = 'flex';
			var queryString = window.location.search;
			queryString = queryString.slice(1);
			var parameters = {};
			queryString.split('&').forEach(pair => {
				const [paramName, paramValue] = pair.split('=').map(decodeURIComponent);
				parameters[paramName] = paramValue;
			});

			userId = parameters["userId"];

			async function send() {
				var responseData = await sendRequest("get", userId);
				if (responseData.status === "ok") {
					flexJsonStatic = responseData.cardJson[0];
					window.flexJsonStaticFromSheet = flexJsonStatic;
					console.log('[download_card] flexJsonStatic 來自 cardJson[0]：', flexJsonStatic);
					const data_card = JSON.parse(responseData.card);
					createFlex(data_card);
					var card = document.querySelector(".downloadFlex");
					domtoimage.toBlob(card).then(function (blob) {
						var link = document.createElement("a");
						link.href = URL.createObjectURL(blob);
						var timestamp = Date.now();
						var mainTitle_1 = data_card.mainTitle_1 || "磊山 人文講堂";
						link.download = mainTitle_1 + "_" + timestamp + ".png";
						link.click();
						URL.revokeObjectURL(link.href);
					}).then(function () {
						alert("下載完成")
						try { liff.closeWindow(); } catch (e) { }
						try { window.close(); } catch (e) { }
					})
						.catch(function (error) {
							alert("下載錯誤\n", error);
						});
				}
			}
			send();
		}
	</script>
</body>

</html>