<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員卡測試頁面</title>
  <link rel="stylesheet" href="../css/style.css">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="container">
    <h1>會員卡測試頁面</h1>
    
    <div class="test-section">
      <h2>LIFF 功能測試</h2>
      <div id="liff-status">LIFF 狀態：載入中...</div>
      <div id="user-info">用戶資訊：載入中...</div>
      <button onclick="testShare()" class="btn btn-primary">測試分享功能</button>
    </div>

    <div class="test-section">
      <h2>卡片功能測試</h2>
      <button onclick="testCreateCard()" class="btn btn-primary">建立測試卡片</button>
      <button onclick="testListCards()" class="btn btn-secondary">列出卡片</button>
      <div id="card-list"></div>
    </div>
  </div>

  <script>
    // 初始化 LIFF
    async function initLiff() {
      try {
        await liff.init({ liffId: '2007327814-BdWpj70m' });
        document.getElementById('liff-status').textContent = 'LIFF 狀態：已初始化';
        
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          document.getElementById('user-info').textContent = `用戶資訊：${profile.displayName}`;
        }
      } catch (error) {
        console.error('LIFF 初始化失敗:', error);
        document.getElementById('liff-status').textContent = 'LIFF 狀態：初始化失敗';
      }
    }

    // 測試分享功能
    async function testShare() {
      try {
        const testCard = {
          type: 'bubble',
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '測試卡片',
                weight: 'bold',
                size: 'xl'
              }
            ]
          }
        };

        if (liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([
            {
              type: 'flex',
              altText: '測試卡片',
              contents: testCard
            }
          ]);
        } else {
          alert('shareTargetPicker 不可用');
        }
      } catch (error) {
        console.error('分享測試失敗:', error);
        alert('分享測試失敗');
      }
    }

    // 測試建立卡片
    async function testCreateCard() {
      try {
        const profile = await liff.getProfile();
        const testCard = {
          type: 'bubble',
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '測試卡片',
                weight: 'bold',
                size: 'xl'
              }
            ]
          }
        };

        const response = await fetch('/api/cards/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cardData: testCard,
            userId: profile.userId
          })
        });

        const result = await response.json();
        alert('測試卡片建立成功');
        testListCards();
      } catch (error) {
        console.error('建立測試卡片失敗:', error);
        alert('建立測試卡片失敗');
      }
    }

    // 測試列出卡片
    async function testListCards() {
      try {
        const profile = await liff.getProfile();
        const response = await fetch(`/api/cards/list?userId=${profile.userId}`);
        const { cards } = await response.json();
        
        const cardList = document.getElementById('card-list');
        cardList.innerHTML = cards.map(card => `
          <div class="card-item">
            <p>卡片 ID: ${card.id}</p>
            <p>建立時間: ${new Date(card.created_at).toLocaleString()}</p>
            <button onclick="testDeleteCard('${card.id}')" class="btn btn-secondary">刪除</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('列出卡片失敗:', error);
        alert('列出卡片失敗');
      }
    }

    // 測試刪除卡片
    async function testDeleteCard(cardId) {
      try {
        const profile = await liff.getProfile();
        const response = await fetch(`/api/cards/delete?cardId=${cardId}&userId=${profile.userId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          alert('卡片刪除成功');
          testListCards();
        } else {
          throw new Error('刪除失敗');
        }
      } catch (error) {
        console.error('刪除卡片失敗:', error);
        alert('刪除卡片失敗');
      }
    }

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', initLiff);
  </script>
</body>
</html>