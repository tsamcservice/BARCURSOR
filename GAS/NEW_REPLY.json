{"files":[{"id":"fa73cf7d-0b3c-4151-9f3e-b957bd5e2ea2","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Etc/GMT-8\",\n  \"dependencies\": {},\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"80ddba1c-c8eb-4c05-9d1b-0018a4d470f6","name":"doPost","type":"server_js","source":"//認證身份 channel_access_token\nvar CHANNEL_ACCESS_TOKEN \u003d \u0027Ldq2Q7r5XtI8wuNuKA+zBmthI2ytWHfHXofMsBWIXnFMRqPjFnFQTRVtr89G/l3+fvIjt4+qPTr9nUAbOLUhLz3pcxgTLZRUQ5v2C9zHEIvUgaQ81asWrepPs1JBcKAYYqrRVDwsHR3lZ/eE7vSi2AdB04t89/1O/w1cDnyilFU\u003d\u0027\n\n//連結google試算表\nvar google_sheet_url \u003d \u0027https://docs.google.com/spreadsheets/d/1_ShBQpCCgzPUPB6glCa7gKEzLRfKQBNu7R6dtrc2utU/edit?gid\u003d0#gid\u003d0\u0027;\nvar spreadsheet \u003d SpreadsheetApp.openByUrl(google_sheet_url);\nvar sheet_line_card \u003d spreadsheet.getSheetByName(\"line_card\"); // line_card資料存放區\nvar sheet_card_json \u003d spreadsheet.getSheetByName(\"card_json\"); // card_json資料存放區\n\nvar today \u003d new Date(); //取得日期與時間\n\nfunction doPost(e) {\n  //接收使用者在 line bot 上所動作的觸發資訊\n  var msg \u003d JSON.parse(e.postData.contents);\n  //從接收到的訊息中取出 replyToken 和發送的訊息文字資訊 \n  var replyToken \u003d msg.events[0].replyToken;\n  var type \u003d msg.events[0].type;\n  var userid \u003d msg.events[0].source.userId;\n  var groupid \u003d msg.events[0].source.groupId;\n  var data_userId \u003d JSON.parse(sheet_line_card.getSheetValues(2, 10, 1, 1)[0][0])\n\n  //判斷訊息格式\n  if (type \u003d\u003d \u0027join\u0027) { }\n  else if (type \u003d\u003d \u0027leave\u0027) { }\n  else if (type \u003d\u003d \"follow\") { }\n  else if (type \u003d\u003d \u0027postback\u0027) { }\n  else if (type \u003d\u003d \u0027message\u0027 \u0026\u0026 msg.events[0].message.text !\u003d null) {\n    var userMessage \u003d msg.events[0].message.text;\n    if (userMessage \u003d\u003d \"顯示名片\") { userMessage \u003d userid }\n    if (userMessage in data_userId \u0026\u0026 userid in data_userId) {\n      N \u003d data_userId[userMessage]\n      var sheet_data_card \u003d sheet_line_card.getSheetValues(N + 2, 3, 1, 1)[0][0]\n      var flexJson \u003d create_flexJson(JSON.parse(sheet_data_card), userMessage)\n      reply_message(replyToken, flexJson)\n    }\n  }\n  else { }\n}\n"},{"id":"2200cdfd-90dc-4a2c-a469-831af9aea26a","name":"other_function()","type":"server_js","source":"// 找出 google sheet 表單內空的格子\nfunction find_vain_N() {\n  var N\n  var data_userId \u003d JSON.parse(sheet_line_card.getSheetValues(2, 10, 1, 1)[0][0])\n  const values \u003d Object.values(data_userId).sort((a, b) \u003d\u003e a - b);\n  var N_Max \u003d values.length \u003e 0 ? Math.max(...values) : -1;\n  const all_numberArr \u003d Array.from({ length: N_Max }, (_, i) \u003d\u003e i);\n  const vain_N_Arr \u003d all_numberArr.filter(num \u003d\u003e !values.includes(num));\n  for (N of vain_N_Arr) {\n    var sheet_userId \u003d sheet_line_card.getSheetValues(N + 2, 2, 1, 1)[0][0]\n    if (sheet_userId \u003d\u003d \"\") { return N }\n  }\n  N \u003d N_Max\n  while (true) {\n    N++\n    var sheet_userId \u003d sheet_line_card.getSheetValues(N + 2, 2, 1, 1)[0][0]\n    if (sheet_userId \u003d\u003d \"\") {\n      return N\n    }\n  }\n}\n\n"},{"id":"a34cd187-7127-4ec1-97b2-0719fbf63e17","name":"create_flexJson()","type":"server_js","source":"//把參數帶入到flexJson訊息中並回傳flexJson\nfunction create_flexJson(sheet_data_card, userId) {\n  //flexJson訊息回覆的參數\n  var textContent_1_url \u003d sheet_data_card.textContent_1_url || \"https://raw.githubusercontent.com/tsamcservice/NEWCURSOR/data/images/TS.jpg\"\n  var textContent_2_url \u003d sheet_data_card.textContent_2_url || \"https://donate.ls-love.org/\"\n  var textColor \u003d sheet_data_card.textColor || \"#000000\"\n  var mainTitle_1 \u003d sheet_data_card.mainTitle_1 || \"呈璽理財藝術共享空間\"\n  var mainTitle_2 \u003d sheet_data_card.mainTitle_2 || \"我在呈璽，欣賞美好幸福 我在呈璽，喝茶喝咖啡很悠閒 我不在呈璽，就是在前往呈璽的路上\"\n  var memberId \u003d sheet_data_card.memberId || \"000\"\n  var subTitle_2 \u003d sheet_data_card.subTitle_2 || \"青藝盟盟主\"\n  var textContent_1 \u003d sheet_data_card.textContent_1 || \"05/06(六)09:50~12:00\"\n  var textContent_2 \u003d sheet_data_card.textContent_2 || \"呈璽LINE@\"\n  var displayName \u003d sheet_data_card.displayName || \"\"\n\n  var flexJsonList \u003d sheet_card_json.getSheetValues(3, 2, 1, 7)[0].filter(value \u003d\u003e value !\u003d\u003d \u0027\u0027)[0]\n  flexJsonList \u003d flexJsonList.replace(/mainTitle_1/g, mainTitle_1);\n  flexJsonList \u003d flexJsonList.replace(/mainTitle_2/g, mainTitle_2);\n  flexJsonList \u003d flexJsonList.replace(/memberId/g, memberId);\n  // flexJsonList \u003d flexJsonList.replace(/subTitle_2/g, \u0027\"\u0027 + subTitle_2 + \u0027\"\u0027);\n  flexJsonList \u003d flexJsonList.replace(/textContent_1_url/g, textContent_1_url);\n  // flexJsonList \u003d flexJsonList.replace(/textContent_1/g, \u0027\"\u0027 + textContent_1 + \u0027\"\u0027);\n  flexJsonList \u003d flexJsonList.replace(/textContent_2_url/g, textContent_2_url);\n  flexJsonList \u003d flexJsonList.replace(/textContent_2/g, textContent_2);\n  flexJsonList \u003d flexJsonList.replace(/displayName/g, displayName);\n  flexJsonList \u003d flexJsonList.replace(/textColor/g, textColor);\n  flexJsonList \u003d flexJsonList.replace(/S{3,}/g, \"https://liff.line.me/\" + \"2007327814-DGly5XNk\" + \"/?userId\u003d\" + encodeURIComponent(userId));\n\n  return [{\n    type: \"flex\",\n    altText: \"Flex Message\",\n    contents: {\n      type: \"carousel\",\n      contents: [JSON.parse(flexJsonList)]\n    }\n  }]\n}"},{"id":"67f5a037-fb97-4966-b353-2d60505107b8","name":"push_message_userid()","type":"server_js","source":"//推波給使用者的訊息程式(任何訊息格式)\nfunction push_message_userid(reply, userid \u003d \"U48f2fd0b385a571e2ea9e355eab78ce7\") {\n  UrlFetchApp.fetch(\u0027https://api.line.me/v2/bot/message/multicast\u0027, {\n    \u0027headers\u0027: {\n      \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n    },\n    \u0027method\u0027: \u0027post\u0027,\n    \u0027payload\u0027: JSON.stringify({\n      \u0027to\u0027: [userid],\n      \u0027messages\u0027: reply\n    }),\n  })\n}"},{"id":"bdf87867-ba21-4b88-a480-b26483807664","name":"push_txt_userid()","type":"server_js","source":"//推波給使用者的訊息程式(只限文字格式)\nfunction push_txt_userid(reply, userid \u003d \"U48f2fd0b385a571e2ea9e355eab78ce7\") {\n  UrlFetchApp.fetch(\u0027https://api.line.me/v2/bot/message/multicast\u0027, {\n    \u0027headers\u0027: {\n      \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n    },\n    \u0027method\u0027: \u0027post\u0027,\n    \u0027payload\u0027: JSON.stringify({\n      \u0027to\u0027: [userid],\n      \u0027messages\u0027: [{ \u0027type\u0027: \u0027text\u0027, \u0027text\u0027: reply }]\n    }),\n  });\n}"},{"id":"d2332dad-1793-4923-980e-c4ac820c9570","name":"push_message_group()","type":"server_js","source":"//推波群組訊息(任何訊息格式)\nfunction push_message_group(groupId, reply) {\n  var url \u003d \u0027https://api.line.me/v2/bot/message/push\u0027\n  UrlFetchApp.fetch(url, {\n    \u0027headers\u0027: {\n      \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN,\n    },\n    \u0027method\u0027: \u0027post\u0027,\n    \u0027payload\u0027: JSON.stringify({\n      \u0027to\u0027: groupId,\n      \u0027messages\u0027: reply\n    }),\n  });\n} "},{"id":"d48279c9-0f56-43ad-80dd-1534143e20db","name":"reply_message()","type":"server_js","source":"// 對於訊息回覆的程式碼\nfunction reply_message(replyToken, reply, url \u003d \u0027https://api.line.me/v2/bot/message/reply\u0027) {\n  UrlFetchApp.fetch(url, {\n    \u0027headers\u0027: { //JavaScript的headers\n      \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_ACCESS_TOKEN, //帶入LINE BOT的channel_access_token\n    },\n    \u0027method\u0027: \u0027post\u0027, //使用POST的方式回傳\n    \u0027payload\u0027: JSON.stringify({ //將訊息轉為JSON格式，JavaScript常用JSON傳輸資料\n      \u0027replyToken\u0027: replyToken,  //每個reply事件專屬的replyToken\n      \u0027messages\u0027: reply //回傳文字訊息，內容為reply也就是userMessage\n    }),\n  });\n}"},{"id":"891f3f2d-d037-4089-970a-f19e762851b5","name":"test","type":"server_js","source":"// 這裡是開發人員測試的地方\nfunction test() {\n  push_txt_userid(\"1\")\n}"}]}